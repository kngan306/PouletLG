@model List<WebLego.Areas.Admin.Models.OrderViewModel>

@{
    ViewData["Title"] = "Quản lý Đơn hàng";
    var statusList = ViewBag.StatusList as List<string>;
    var orderTypes = ViewBag.OrderTypes as List<string>;
    string selectedStatus = Context.Request.Query["statusFilter"];
    string selectedMonth = Context.Request.Query["month"];
    string selectedYear = Context.Request.Query["year"];
}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

@if (TempData["BulkError"] != null)
{
    <div class="alert alert-warning">@TempData["BulkError"]</div>
}
<form method="get" asp-action="Index" class="row g-3 align-items-center mb-4">

    <div class="col-auto">
        <label for="statusFilter" class="form-label fw-bold">Trạng thái:</label>
        <select id="statusFilter" name="statusFilter" class="form-select">
            <option value="">-- Tất cả --</option>
            @if (statusList != null)
            {
                foreach (var status in statusList)
                {
                    if (status == selectedStatus)
                    {
                        <option value="@status" selected>@status</option>
                    }
                    else
                    {
                        <option value="@status">@status</option>
                    }
                }
            }

        </select>
    </div>

    <div class="col-auto">
        <label for="month" class="form-label fw-bold">Tháng:</label>
        <select id="month" name="month" class="form-select">
            <option value="">-- Tất cả --</option>
            @for (int m = 1; m <= 12; m++)
            {
                if (m.ToString() == selectedMonth)
                {
                    <option value="@m" selected="selected">@m</option>
                }
                else
                {
                    <option value="@m">@m</option>
                }
            }

        </select>
    </div>

    <div class="col-auto">
        <label for="year" class="form-label fw-bold">Năm:</label>
        <select id="year" name="year" class="form-select">
            <option value="">-- Tất cả --</option>
            @{
                int currentYear = DateTime.Now.Year;
                for (int y = currentYear; y >= currentYear - 10; y--)
                {
                    if (y.ToString() == selectedYear)
                    {
                        <option value="@y" selected="selected">@y</option>
                    }
                    else
                    {
                        <option value="@y">@y</option>
                    }
                }

            }
        </select>
    </div>

    <div class="col-auto align-self-end">
        <button type="submit" class="btn btn-primary">Lọc</button>
    </div>
</form>

<table class="table table-striped table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>Mã đơn</th>
            <th>Khách hàng</th>
            <th>Ngày đặt</th>
            <th>Trạng thái</th>
            <th>Tổng tiền</th>
            <th>Chi tiết</th>
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="6" class="text-center">Chưa có đơn hàng nào.</td>
            </tr>
        }
        else
        {
            foreach (var order in Model)
            {
                <tr>
                    <td>@order.OrderId</td>
                    <td>@order.CustomerName</td>
                    <td>@order.OrderDate?.ToString("dd/MM/yyyy")</td>
                    <td>
                        @{
                            var currentStatus = order.OrderStatus;
                            var currentRoleId = (int?)ViewBag.CurrentRoleId ?? 0; // Role từ ViewBag
                            List<string> nextStatuses = new List<string>();

                            if (currentRoleId == 3) // Quản lý
                            {
                                if (currentStatus == "Đang xử lý")
                                    nextStatuses.Add("Đang giao hàng");
                                else if (currentStatus == "Đang giao hàng")
                                    nextStatuses.Add("Hoàn thành");
                            }
                            else if (currentRoleId == 2) // Nhân viên bán hàng
                            {
                                if (currentStatus == "Đang xử lý")
                                    nextStatuses.Add("Đang giao hàng");
                            }

                            if (nextStatuses.Any())
                            {
                                <select class="form-select form-select-sm status-dropdown"
                                        data-order-id="@order.OrderId"
                                        data-current-status="@currentStatus"
                                        aria-label="Chọn trạng thái đơn hàng">
                                    <option selected disabled>@currentStatus</option>
                                    @foreach (var status in nextStatuses)
                                    {
                                        <option value="@status">@status</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <span>@currentStatus</span>
                            }
                        }
                    </td>
                    <td>@(order.TotalAmount?.ToString("N0") ?? "0") VNĐ</td>
                    <td>
                        <a asp-area="Admin" asp-controller="Orders" asp-action="Details" asp-route-orderId="@order.OrderId" class="btn btn-sm btn-info">Xem</a>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<!-- Modal Bootstrap 5 -->
<div class="modal fade" id="assignShipperModal" tabindex="-1" aria-labelledby="assignShipperLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="assignShipperForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignShipperLabel">Chọn nhân viên giao hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalOrderId" />
                <div class="mb-3">
                    <label for="shipperSelect" class="form-label">Nhân viên giao hàng:</label>
                    <select class="form-select" id="shipperSelect" required></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Gán nhân viên</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            var assignModal = new bootstrap.Modal(document.getElementById('assignShipperModal'));

            $('.status-dropdown').on('change', function () {
                var dropdown = $(this);
                var orderId = dropdown.data('order-id');
                var currentStatus = dropdown.data('current-status');
                var newStatus = dropdown.val();

                if (currentStatus === "Đang xử lý" && newStatus === "Đang giao hàng") {
                    // Hiện modal chọn nhân viên
                    $('#modalOrderId').val(orderId);

                    // Gọi API lấy danh sách nhân viên giao hàng
                    $.get('/Admin/Orders/GetDeliveryStaffs', function (staffs) {
                        var shipperSelect = $('#shipperSelect');
                        shipperSelect.empty();
                        staffs.forEach(function (staff) {
                            shipperSelect.append(`<option value="${staff.userId}">${staff.fullName}</option>`);
                        });

                        assignModal.show();
                    });
                } else {
                    // Gửi Ajax cập nhật trạng thái bình thường
                    updateOrderStatus(orderId, newStatus);
                }
            });

            // Khi submit modal gán nhân viên
            $('#assignShipperForm').on('submit', function (e) {
                e.preventDefault();
                var orderId = $('#modalOrderId').val();
                var shipperId = $('#shipperSelect').val();

                $.post('/Admin/Orders/AssignDeliveryStaff', { orderId, shipperId }, function () {
                    updateOrderStatus(orderId, 'Đang giao hàng');
                    assignModal.hide();
                }).fail(function () {
                    alert('Lỗi khi gán nhân viên.');
                });
            });

            function updateOrderStatus(orderId, newStatus) {
                $.post('/Admin/Orders/UpdateStatus', { orderId, newStatus }, function () {
                    alert('Cập nhật trạng thái thành công!');
                    location.reload();
                }).fail(function () {
                    alert('Lỗi cập nhật trạng thái.');
                });
            }
        });
    </script>
}
