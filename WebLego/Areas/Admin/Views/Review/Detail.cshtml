@model WebLego.Areas.Admin.Models.ReviewViewModel

@{
    ViewData["Title"] = "Chi tiết đánh giá";
}

@* <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" /> *@
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="container py-4">
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary mb-4">
        <i class="bi bi-arrow-left"></i> Quay lại
    </a>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">Đánh giá #@Model.ReviewId</h5>

            <dl class="row mb-3">
                <dt class="col-sm-3">Sản phẩm:</dt>
                <dd class="col-sm-9">@Model.ProductName</dd>

                <dt class="col-sm-3">Người dùng:</dt>
                <dd class="col-sm-9">@Model.UserName</dd>

                <dt class="col-sm-3">Điểm đánh giá:</dt>
                <dd class="col-sm-9 text-warning fs-5">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <i class="bi @(i <= Model.Rating ? "bi-star-fill" : "bi-star")"></i>
                    }
                </dd>

                <dt class="col-sm-3">Bình luận:</dt>
                <dd class="col-sm-9">@(!string.IsNullOrWhiteSpace(Model.Comment) ? Model.Comment : "Không có")</dd>

                <dt class="col-sm-3">Hình ảnh:</dt>
                <dd class="col-sm-9">
                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <img src="@Model.ImageUrl" alt="Hình ảnh đánh giá" class="img-thumbnail" style="max-width: 250px;" />
                    }
                    else
                    {
                        <span class="text-muted fst-italic">Không có</span>
                    }
                </dd>

                <dt class="col-sm-3">Ngày tạo:</dt>
                <dd class="col-sm-9">@Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</dd>

                @if (Model.IsUpdated)
                {
                    <dt class="col-sm-3">Ngày cập nhật:</dt>
                    <dd class="col-sm-9">@Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</dd>
                }

                <dt class="col-sm-3">Trạng thái:</dt>
                <dd class="col-sm-9">@Model.ReviewStatus</dd>

                <dt class="col-sm-3">Gắn cờ:</dt>
                <dd class="col-sm-9">
                    <span class="badge @(Model.IsFlagged ? "bg-danger" : "bg-secondary")">
                        @(Model.IsFlagged ? "Có" : "Không")
                    </span>
                </dd>

                <dt class="col-sm-3">Phản hồi Admin:</dt>
                <dd class="col-sm-9">@(!string.IsNullOrWhiteSpace(Model.AdminReply) ? Model.AdminReply : "Chưa có")</dd>

                @if (Model.AdminReplyAt.HasValue)
                {
                    <dt class="col-sm-3">Ngày phản hồi:</dt>
                    <dd class="col-sm-9">@Model.AdminReplyAt?.ToString("dd/MM/yyyy HH:mm")</dd>

                    @if (Model.CreatedAt.HasValue && Model.AdminReplyAt > Model.CreatedAt.Value.AddSeconds(10))
                    {
                        <dt class="col-sm-3">Trạng thái phản hồi:</dt>
                        <dd class="col-sm-9"><span class="text-muted fst-italic">Phản hồi đã được cập nhật</span></dd>
                    }
                }
            </dl>

            <hr />

            <!-- Form phản hồi Admin -->
            <form id="replyForm" class="mb-4">
                <div class="mb-3">
                    <label for="adminReply" class="form-label fw-semibold">Phản hồi Admin:</label>
                    <textarea id="adminReply" class="form-control" rows="4" placeholder="Nhập phản hồi của bạn...">@Model.AdminReply</textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i> Cập nhật phản hồi
                </button>
            </form>

            <!-- Form gắn cờ -->
            <form id="flagForm">
                <button type="submit" class="btn @(Model.IsFlagged ? "btn-success" : "btn-danger")">
                    <i class="bi @(Model.IsFlagged ? "bi-flag-fill" : "bi-flag")"></i>
                    @(Model.IsFlagged ? "Bỏ gắn cờ" : "Gắn cờ và ẩn")
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function () {
            $('#replyForm').submit(function (e) {
                e.preventDefault();
                var adminReply = $('#adminReply').val();
                $.ajax({
                    url: '@Url.Action("Reply", "Review", new { area = "Admin" })',
                    type: 'POST',
                    data: { reviewId: @Model.ReviewId, adminReply: adminReply },
                    success: function (res) {
                        if (res.success) {
                            alert(res.message);
                            location.reload();
                        } else {
                            alert(res.message);
                        }
                    },
                    error: function () {
                        alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
                    }
                });
            });

            $('#flagForm').submit(function (e) {
                e.preventDefault();
                var confirmMsg = '@(Model.IsFlagged ? "bỏ gắn cờ" : "gắn cờ và ẩn")';
                if (confirm(`Bạn có chắc chắn muốn ${confirmMsg} đánh giá này?`)) {
                    $.ajax({
                        url: '@Url.Action("ToggleFlag", "Review", new { area = "Admin" })',
                        type: 'POST',
                        data: { reviewId: @Model.ReviewId },
                        success: function (res) {
                            if (res.success) {
                                alert(res.message);
                                location.reload();
                            } else {
                                alert(res.message);
                            }
                        },
                        error: function () {
                            alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
                        }
                    });
                }
            });
        });
    </script>
}
