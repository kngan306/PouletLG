@model WebLego.Areas.Admin.Models.CategoryViewModel
@{
    ViewData["Title"] = "Quản lý danh mục";
    var roleId = int.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "0");
}

@if (TempData["BulkError"] != null)
{
    <div class="alert alert-warning">@TempData["BulkError"]</div>
}

<style>
    .card-header {
        font-weight: 600;
        font-size: 1.1rem;
        background-color: #f8f9fa;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .form-label {
        font-weight: 500;
    }

    .pagination .page-link {
        color: #0d6efd;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    #selectedCountLabel {
        font-weight: 500;
    }

    .btn-sm i, .btn i {
        vertical-align: middle;
    }

    .modal-content {
        border-radius: 12px;
    }
</style>

<div class="card mb-4 shadow-sm rounded">
    <div class="card-header">
        <i class="bi bi-search me-2"></i>
        Tìm kiếm thông tin danh mục sản phẩm
    </div>
    <div class="card-body">
        <form asp-action="Index" method="get" class="row gy-2 gx-3 align-items-end">
            <div class="col-md-4">
                <label for="filterCode" class="form-label">Mã danh mục</label>
                <input type="text" id="filterCode" name="filterCode"
                       value="@Model.FilterCode" class="form-control" placeholder="Nhập mã..." />
            </div>
            <div class="col-md-4">
                <label for="filterName" class="form-label">Tên danh mục</label>
                <input type="text" id="filterName" name="filterName"
                       value="@Model.FilterName" class="form-control" placeholder="Nhập tên..." />
            </div>
            <div class="col-md-4 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Tìm kiếm
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-x-circle"></i> Đặt lại
                </a>
            </div>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    @if (roleId == 3)
    {
        <a asp-action="Create" class="btn btn-warning text-dark shadow-sm">
            <i class="bi bi-plus-circle me-1"></i> Tạo mới
        </a>
    }

    @if (roleId == 3)
    {
        <div class="d-flex align-items-center">
            <span id="selectedCountLabel" class="me-3 text-secondary">
                (0) Dòng được chọn
            </span>
            <button id="btnDeleteSelected"
                    type="button"
                    class="btn btn-danger shadow-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmBulkDelete"
                    disabled>
                <i class="bi bi-trash me-1"></i> Xóa
            </button>
        </div>
    }
</div>

<form id="bulkDeleteForm" asp-action="DeleteSelected" method="post">
    @Html.AntiForgeryToken()
    <table class="table table-hover table-bordered shadow-sm rounded">
        <thead class="table-light">
            <tr>
                <th class="text-center" style="width:40px;">
                    @if (roleId == 3)
                    {
                        <input type="checkbox" id="selectAll" />
                    }
                </th>
                <th class="text-center" style="width:60px;">STT</th>
                <th>Mã Danh Mục</th>
                <th>Tên Danh Mục</th>
                <th class="text-center" style="width:140px;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @{
                var sttStart = (Model.Page - 1) * Model.PageSize;
            }
            @for (int i = 0; i < Model.Categories.Count; i++)
            {
                var item = Model.Categories[i];
                <tr>
                    <td class="text-center">
                        @if (roleId == 3)
                        {
                            <input type="checkbox" class="row-checkbox" name="selectedIds" value="@item.CategoryId" />
                        }
                    </td>
                    <td class="text-center">@((sttStart) + i + 1)</td>
                    <td>@item.CategoryId</td>
                    <td>@item.CategoryName</td>
                    <td class="text-center">
                        <a asp-action="Edit"
                           asp-route-id="@item.CategoryId"
                           class="btn btn-sm btn-outline-primary me-1"
                           title="@(roleId == 3 ? "Sửa" : "Xem chi tiết")">
                            <i class="bi @(roleId == 3 ? "bi-pencil" : "bi-eye")"></i>
                        </a>
                        @if (roleId == 3)
                        {
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    title="Xóa"
                                    onclick="showSingleDeleteModal(@item.CategoryId)">
                                <i class="bi bi-trash"></i>
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</form>

@{
    var totalPages = (Model.TotalItems + Model.PageSize - 1) / Model.PageSize;
}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3">
        <li class="page-item @(Model.Page == 1 ? "disabled" : "")">
            <a class="page-link"
               asp-action="Index"
               asp-route-page="@(Model.Page-1)"
               asp-route-filterCode="@Model.FilterCode"
               asp-route-filterName="@Model.FilterName">
                « Trước
            </a>
        </li>
        @for (int p = 1; p <= totalPages; p++)
        {
            <li class="page-item @(p == Model.Page ? "active" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@p"
                   asp-route-filterCode="@Model.FilterCode"
                   asp-route-filterName="@Model.FilterName">
                    @p
                </a>
            </li>
        }
        <li class="page-item @(Model.Page >= totalPages ? "disabled" : "")">
            <a class="page-link"
               asp-action="Index"
               asp-route-page="@(Model.Page+1)"
               asp-route-filterCode="@Model.FilterCode"
               asp-route-filterName="@Model.FilterName">
                Sau »
            </a>
        </li>
    </ul>
</nav>

<!-- Modal xác nhận xóa nhiều -->
<div class="modal fade" id="confirmBulkDelete" tabindex="-1" role="dialog"
     aria-labelledby="bulkDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn xóa
                <strong><span id="selectedCountModal">0</span></strong>
                mục này?
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary btn-sm"
                        data-bs-dismiss="modal">
                    Hủy
                </button>
                <button type="button" id="confirmBulkBtn"
                        class="btn btn-danger btn-sm">
                    Xóa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận xóa từng danh mục -->
<div class="modal fade" id="confirmSingleDelete" tabindex="-1" role="dialog"
     aria-labelledby="singleDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn xóa danh mục này?
            </div>
            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary btn-sm"
                        data-bs-dismiss="modal">
                    Hủy
                </button>
                <button type="button" class="btn btn-danger btn-sm" id="confirmSingleBtn">
                    Xóa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Form ẩn để xóa từng dòng -->
<form id="singleDeleteForm" asp-action="Delete" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="singleDeleteId" />
</form>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const selectAll = document.getElementById('selectAll');
            const rows = document.querySelectorAll('.row-checkbox');
            const btnDelete = document.getElementById('btnDeleteSelected');
            const countLabel = document.getElementById('selectedCountLabel');
            const countLabelModal = document.getElementById('selectedCountModal');
            const confirmBulkBtn = document.getElementById('confirmBulkBtn');
            const bulkForm = document.getElementById('bulkDeleteForm');

            function updateCount() {
                const c = document.querySelectorAll('.row-checkbox:checked').length;
                countLabel.textContent = `(${c}) Dòng được chọn`;
                countLabelModal.textContent = c;
                btnDelete.disabled = c === 0;
            }

            if (selectAll) {
                selectAll.addEventListener('change', e => {
                    rows.forEach(r => r.checked = e.target.checked);
                    updateCount();
                });
            }

            rows.forEach(r => r.addEventListener('change', updateCount));
            confirmBulkBtn.addEventListener('click', () => bulkForm.submit());
        });

        // Xử lý popup xác nhận xóa từng dòng
        let categoryIdToDelete = 0;
        function showSingleDeleteModal(id) {
            categoryIdToDelete = id;
            var modal = new bootstrap.Modal(document.getElementById('confirmSingleDelete'));
            modal.show();
        }

        document.getElementById('confirmSingleBtn').addEventListener('click', function () {
            document.getElementById('singleDeleteId').value = categoryIdToDelete;
            document.getElementById('singleDeleteForm').submit();
        });
    </script>
}
