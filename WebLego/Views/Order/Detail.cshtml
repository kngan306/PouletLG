@model WebLego.Models.ViewModel.OrderViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    var order = Model;
    var totalItemCost = order.Items.Sum(i => i.Price * i.Quantity);
    var shippingFee = order.ShippingFee > 0 ? order.ShippingFee : 30000m;
}

<link href="~/css/checkout.css" rel="stylesheet" />
<link href="~/css/detailorder.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="checkout-container">
    <h2>Chi tiết đơn hàng</h2>

    @if (!string.IsNullOrEmpty(TempData["ReviewSuccess"] as string))
    {
        <div class="alert alert-success">
            <p>@TempData["ReviewSuccess"]</p>
        </div>
    }

    @if ((order.OrderStatus == "Chờ thanh toán" && order.ExpirationDate.HasValue) ||
        (order.OrderStatus == "Đã hủy" && order.ExpirationDate.HasValue && order.ExpirationDate.Value < DateTime.Now))
    {
        var expirationSeconds = order.ExpirationDate.HasValue ? (order.ExpirationDate.Value - DateTime.Now).TotalSeconds : 0;

        @if (order.OrderStatus == "Chờ thanh toán" && expirationSeconds > 0)
        {
            <div class="alert alert-warning">
                <p>Đơn hàng sẽ tự hủy sau <span id="timer-@order.OrderId">@TimeSpan.FromSeconds(expirationSeconds).ToString(@"hh\:mm\:ss")</span>. Vui lòng hoàn tất thanh toán!</p>
            </div>
            <script>
                (function (orderId) {
                    var timeLeft = @expirationSeconds;
                    var timer = setInterval(function () {
                        timeLeft--;
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            alert("Đơn hàng #" + orderId + " đã bị hủy do hết thời gian.");
                            window.location.href = '@Url.Action("Index", "Order")';
                        } else {
                            var time = new Date(timeLeft * 1000).toISOString().substr(11, 8);
                            document.getElementById("timer-" + orderId).textContent = time;
                        }
                    }, 1000);
                })(@order.OrderId);
            </script>
        }
        else if (order.OrderStatus == "Đã hủy" && order.ExpirationDate.Value < DateTime.Now)
        {
            <div class="alert alert-warning">
                <p>Đơn hàng đã bị hủy do hết thời gian thanh toán.</p>
            </div>
        }
    }

    <!-- ĐỊA CHỈ NHẬN HÀNG -->
    <div class="card mb-3">
        <div class="card-header fw-bold">
            <img src="~/images/icon_address.png" class="section-icon icon-address" alt="Biểu tượng địa chỉ"> Địa chỉ nhận hàng
        </div>
        <div class="card-body">
            @if (order.Address != null)
            {
                <div class="address-details">
                    <span class="address-name-phone"><strong>@order.Address.FullName</strong> (+84) @order.Address.Phone</span>
                    <span class="address-specific">@order.Address.SpecificAddress, @order.Address.Ward, @order.Address.District, @order.Address.Province</span>
                </div>
            }
            else
            {
                <p class="text-danger">Vui lòng kiểm tra lại dữ liệu địa chỉ trong cơ sở dữ liệu.</p>
            }
        </div>
    </div>

    <!-- THÔNG TIN ĐƠN HÀNG -->
    <div class="card mb-3">
        <div class="card-header fw-bold">
            <img src="~/images/icon_info.png" class="section-icon icon-info" alt="Biểu tượng thông tin"> Thông tin đơn hàng
        </div>
        <div class="card-body">
            <p><strong>Ngày đặt hàng:</strong> @order.OrderDate.ToString("dd/MM/yyyy HH:mm")</p>
            <p><strong>Trạng thái:</strong> @order.OrderStatus</p>
            <p><strong>Phương thức thanh toán:</strong> @order.PaymentMethod</p>
            <p><strong>Trạng thái thanh toán:</strong> @order.PaymentStatus</p>
            @if (!string.IsNullOrEmpty(order.VnpTransactionNo))
            {
                <p><strong>Mã giao dịch VNPAY:</strong> @order.VnpTransactionNo</p>
            }
            @if (order.VnpTransactionDate.HasValue)
            {
                <p><strong>Ngày giao dịch VNPAY:</strong> @order.VnpTransactionDate.Value.ToString("dd/MM/yyyy HH:mm:ss")</p>
            }
        </div>
    </div>

    <!-- DANH SÁCH SẢN PHẨM -->
    <div class="card mb-3">
        <div class="card-header fw-bold">
            <img src="~/images/icon_product.png" class="section-icon icon-product" alt="Biểu tượng sản phẩm"> Sản phẩm
        </div>
        <div class="card-body">
            <table class="table checkout-table">
                <thead>
                    <tr>
                        <th scope="col"></th>
                        <th scope="col">Tên sản phẩm</th>
                        <th scope="col">Giá</th>
                        <th scope="col">Số lượng</th>
                        <th scope="col">Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in order.Items)
                    {
                        <tr>
                            <td>
                                <img src="@item.ImageUrl" class="checkout-image" alt="@item.ProductName" style="max-width: 80px;" />
                            </td>
                            <td>@item.ProductName</td>
                            <td>
                                @if (item.IsDiscounted)
                                {
                                    <span class="text-decoration-line-through text-muted me-2">@item.OriginalPrice.ToString("N0")₫</span>
                                    <span class="text-danger fw-bold">@item.Price.ToString("N0")₫</span>
                                }
                                else
                                {
                                    <span>@item.Price.ToString("N0")₫</span>
                                }
                            </td>
                            <td>@item.Quantity</td>
                            <td>@((item.Price * item.Quantity).ToString("N0"))₫</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="text-end">
                <strong>Tổng số tiền (@order.Items.Count sản phẩm):</strong>
                <span class="text-danger fw-bold">@totalItemCost.ToString("N0")₫</span>
            </div>
        </div>
    </div>

    <!-- MÃ GIẢM GIÁ -->
    <div class="card mb-3">
        <div class="card-header fw-bold">
            <img src="~/images/icon_voucher.png" class="section-icon icon-voucher" alt="Biểu tượng mã giảm giá"> Mã giảm giá
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(order.DiscountCode) && order.DiscountAmount > 0)
            {
                <p><strong>Mã giảm giá:</strong> <span style="font-weight: 500;">@order.DiscountCode</span></p>
                <p><strong>Số tiền giảm:</strong> <span class="text-danger fw-bold">-@order.DiscountAmount.ToString("N0")₫</span></p>
            }
            else
            {
                <p>Không áp dụng mã giảm giá cho đơn hàng này.</p>
            }
        </div>
    </div>

    <!-- TỔNG THANH TOÁN -->
    <div class="card mb-3 payment-total-card">
        <div class="card-header fw-bold">
            <img src="~/images/icon_payment.png" class="section-icon icon-payment" alt="Biểu tượng thanh toán"> Tổng thanh toán
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(TempData["Message"] as string))
            {
                <p class="message-success">@TempData["Message"]</p>
            }
            @if (!string.IsNullOrEmpty(TempData["Error"] as string))
            {
                <p class="message-error">@TempData["Error"]</p>
            }
            <div class="payment-details">
                <strong>Phương thức thanh toán:</strong> @order.PaymentMethod
            </div>
            <div class="payment-layout">
                <div class="payment-details-placeholder"></div>
                <div class="payment-breakdown">
                    <p><strong>Tổng tiền hàng:</strong> @totalItemCost.ToString("N0")₫</p>
                    @if (!string.IsNullOrEmpty(order.DiscountCode) && order.DiscountAmount > 0)
                    {
                        <p><strong>Mã giảm giá (@order.DiscountCode):</strong> -@order.DiscountAmount.ToString("N0")₫</p>
                    }
                    <p><strong>Phí vận chuyển:</strong> @shippingFee.ToString("N0")₫</p>
                    <p class="total-amount"><strong>Tổng thanh toán:</strong> <span class="text-danger fs-5 fw-bold">@order.TotalAmount.ToString("N0")₫</span></p>
                </div>
            </div>
            <div class="button-container">
                <a asp-action="Index" class="btn btn-back">Quay lại</a>
                <div class="action-buttons">
                    @if (order.OrderStatus == "Chờ thanh toán" && order.ExpirationDate.HasValue && order.ExpirationDate.Value > DateTime.Now)
                    {
                        <a asp-action="RetryPayment" asp-route-orderId="@order.OrderId" class="btn btn-yellow">Thanh toán lại</a>
                    }
                    @if (order.OrderStatus == "Hoàn thành")
                    {
                        <button class="btn btn-yellow" data-bs-toggle="modal" data-bs-target="#reviewModal">
                            @(order.Reviews.Any() ? "Xem đánh giá" : "Đánh giá")
                        </button>
                        @if (ViewBag.CanShare)
                        {
                            <button class="btn btn-yellow share-post"
                                    data-bs-toggle="modal"
                                    data-bs-target="#sharePostModal"
                                    data-order-id="@order.OrderId">
                                @(Model.CommunityPosts != null && Model.CommunityPosts.Any() ? "Xem chia sẻ" : "Chia sẻ")
                            </button>
                        }
                    }
                    @if (order.OrderStatus != "Hoàn thành" && order.OrderStatus != "Đã hủy" && order.OrderStatus != "Đổi/Trả hàng")
                    {
                        <form asp-action="CancelOrder" method="post" style="display:inline;">
                            <input type="hidden" name="orderId" value="@order.OrderId" />
                            <button type="submit" class="btn btn-cancel" @(order.OrderStatus != "Chờ thanh toán" && order.OrderStatus != "Đang xử lý" ? "disabled" : "") onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')">Hủy đơn hàng</button>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Đánh Giá -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">
                        @(Model.Reviews.Any() ? "Xem đánh giá đơn hàng #" + Model.OrderId : "Đánh giá sản phẩm đơn hàng #" + Model.OrderId)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @if (Model.OrderStatus == "Hoàn thành")
                    {
                        <div class="reviews-list mb-4">
                            @{
                                int index = 0;
                            }
                            @foreach (var item in Model.Items)
                            {
                                var review = Model.Reviews.FirstOrDefault(r => r.ProductId == item.ProductId);
                                <div class="review-item mb-3 border-bottom pb-3">
                                    <div class="product-info-left mb-2">
                                        <img src="@(string.IsNullOrEmpty(item.ImageUrl) ? "~/images/placeholder.png" : item.ImageUrl)" class="checkout-image" alt="@item.ProductName" />
                                        <h6>@item.ProductName</h6>
                                    </div>
                                    <div class="review-content-container">
                                        @if (review != null && item.HasReviewed)
                                        {
                                            <div class="review-details" id="review-details-@review.ReviewId">
                                                @if (review.IsFlagged)
                                                {
                                                    <p class="text-danger fw-bold">Đánh giá này đã bị ẩn do vi phạm chính sách.</p>
                                                }
                                                <div class="rating-container mb-2 review-details">
                                                    <label class="form-label">Chất lượng sản phẩm:</label>
                                                    <span class="star-rating star-rating-static">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <i class="bi bi-star@(i <= review.Rating.GetValueOrDefault() ? "-fill" : "") star @(i <= review.Rating.GetValueOrDefault() ? "filled" : "")" data-value="@i"></i>
                                                        }
                                                    </span>
                                                </div>
                                                @if (!string.IsNullOrEmpty(review.Comment))
                                                {
                                                    <div class="comment-container mb-2 review-details">
                                                        <label class="form-label">Bình luận:</label>
                                                        <p class="comment-text">@review.Comment</p>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(review.ImageUrl))
                                                {
                                                    <div class="image-container mb-2 review-details">
                                                        <label class="form-label">Hình ảnh:</label>
                                                        <div class="image-wrapper">
                                                            <img src="@review.ImageUrl" alt="Hình ảnh đánh giá" class="review-image" />
                                                        </div>
                                                    </div>
                                                }
                                            <span class="text-muted small">
                                                @(review.IsUpdated
                                                                                        ? $"Cập nhật: {review.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")}"
                                                                                        : $"Đã gửi: {review.CreatedAt?.ToString("dd/MM/yyyy HH:mm")}")
                                    </span>
                                    @if (!review.IsFlagged && !review.IsUpdated && review.CreatedAt.HasValue && review.CreatedAt.Value.AddDays(7) >= DateTime.Now)
                                                {
                                                    <p class="text-info small">Bạn có thể cập nhật lại đánh giá cho sản phẩm này trong vòng 7 ngày kể từ khi gửi.</p>
                                                    <button class="btn btn-sm btn-yellow mt-2" data-bs-toggle="collapse" data-bs-target="#editReview-@review.ReviewId" onclick="toggleEditReview(@review.ReviewId)">Chỉnh sửa đánh giá</button>
                                                }
                                                @if (!string.IsNullOrEmpty(review.AdminReply))
                                                {
                                                    <div class="admin-reply mt-2">
                                                        <strong style="font-size: 15px">Phản hồi từ người bán</strong> -
                                                        <span class="text-muted small">
                                                            @(review.AdminReplyAt.HasValue && review.CreatedAt.HasValue && review.AdminReplyAt.Value <= review.CreatedAt.Value.AddSeconds(10)
                                                                                                        ? $"Đã gửi: {review.AdminReplyAt?.ToString("dd/MM/yyyy HH:mm")}"
                                                                                                        : $"Cập nhật: {review.AdminReplyAt?.ToString("dd/MM/yyyy HH:mm")}")
                                        </span>
                                        <p class="comment-text">@review.AdminReply</p>
                                    </div>
                                                                        }
                                                else
                                                {
                                                    <p class="text-muted small mt-2">Người bán chưa phản hồi</p>
                                                }
                                            </div>
                                            @if (!review.IsFlagged)
                                            {
                                                <div class="collapse mt-3" id="editReview-@review.ReviewId">
                                                    <form class="edit-review-form" data-review-id="@review.ReviewId" data-product-name="@item.ProductName" enctype="multipart/form-data">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="orderId" value="@Model.OrderId" />
                                                        <input type="hidden" name="reviewIds[0]" value="@review.ReviewId" />
                                                        <div class="mb-3 rating-container">
                                                            <label class="form-label">Chất lượng sản phẩm:</label>
                                                            <div class="star-rating" data-review-id="@review.ReviewId">
                                                                @for (int j = 1; j <= 5; j++)
                                                                {
                                                                    <i class="bi bi-star@(j <= review.Rating.GetValueOrDefault() ? "-fill" : "") star @(j <= review.Rating.GetValueOrDefault() ? "filled" : "")" data-value="@j"></i>
                                                                }
                                                            </div>
                                                            <input type="hidden" name="ratings[0]" class="rating-input" value="@review.Rating.GetValueOrDefault()" />
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Bình luận:</label>
                                                            <textarea name="comments[0]" class="form-control comment-input" rows="4">@(review.Comment ?? "")</textarea>
                                                        </div>
                                                        <div class="mb-3 image-container">
                                                            <label class="form-label">Hình ảnh:</label>
                                                            @if (!string.IsNullOrEmpty(review.ImageUrl))
                                                            {
                                                                <div class="image-wrapper">
                                                                    <span class="image-label">Ảnh hiện tại:</span>
                                                                    <img src="@review.ImageUrl" alt="Hình ảnh đánh giá hiện tại" class="review-image" />
                                                                </div>
                                                            }
                                                            <div class="image-upload-wrapper">
                                                                <span class="image-label">Tải ảnh mới (tùy chọn):</span>
                                                                <input type="file" name="images[0]" class="form-control image-input" accept=".jpg,.jpeg,.png" />
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-yellow submit-edit-review">Cập nhật</button>
                                                    </form>
                                                </div>
                                            }
                                        }
                                        else if (!item.HasReviewed)
                                        {
                                            <div class="review-form-container">
                                                <form class="review-form" data-product-id="@item.ProductId" data-product-name="@item.ProductName" enctype="multipart/form-data">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="orderId" value="@Model.OrderId" />
                                                    <input type="hidden" name="productIds[0]" value="@item.ProductId" />
                                                    <div class="mb-3 rating-container">
                                                        <label class="form-label">Chất lượng sản phẩm:</label>
                                                        <div class="star-rating" data-product-id="@item.ProductId">
                                                            @for (int j = 1; j <= 5; j++)
                                                            {
                                                                <i class="bi bi-star star" data-value="@j"></i>
                                                            }
                                                        </div>
                                                        <input type="hidden" name="ratings[0]" class="rating-input" value="0" />
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Bình luận:</label>
                                                        <textarea name="comments[0]" class="form-control comment-input" rows="4"></textarea>
                                                    </div>
                                                    <div class="mb-3 image-container">
                                                        <label class="form-label">Hình ảnh:</label>
                                                        <div class="image-upload-wrapper">
                                                            <input type="file" name="images[0]" class="form-control image-input" accept=".jpg,.jpeg,.png" />
                                                        </div>
                                                    </div>
                                                    <button type="button" class="btn btn-yellow submit-review">Gửi đánh giá</button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                </div>
                                index++;
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-back" data-bs-dismiss="modal">Hủy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chia Sẻ Bài Viết -->
    <div class="modal fade" id="sharePostModal" tabindex="-1" aria-labelledby="sharePostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sharePostModalLabel">Chia sẻ bài viết cuộc thi đơn hàng #@Model.OrderId</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="share-posts-list mb-4">
                        @{
                            int shareIndex = 0;
                        }
                        @foreach (var item in Model.Items)
                        {
                            var post = Model.CommunityPosts?.FirstOrDefault(p => p.ProductId == item.ProductId && p.OrderId == Model.OrderId);
                            <div class="share-post-item mb-3 border-bottom pb-3">
                                <div class="product-info-left mb-2">
                                    <img src="@(string.IsNullOrEmpty(item.ImageUrl) ? "~/images/placeholder.png" : item.ImageUrl)" class="checkout-image" alt="@item.ProductName" />
                                    <h6>@item.ProductName</h6>
                                </div>
                                <div class="share-post-content-container">
                                    @if (post != null)
                                    {
                                        <div class="post-details" id="post-details-@post.PostId">
                                            @if (post.IsFlagged)
                                            {
                                                <p class="text-danger fw-bold">Bài đăng này đã bị ẩn do vi phạm chính sách.</p>
                                            }
                                            <div class="description-container mb-2 post-details">
                                                <label class="form-label">Mô tả:</label>
                                                <p class="description-text">@post.Description</p>
                                            </div>
                                            @if (!string.IsNullOrEmpty(post.ImageUrl))
                                            {
                                                <div class="image-container mb-2 post-details">
                                                    <label class="form-label">Hình ảnh:</label>
                                                    <div class="image-wrapper">
                                                        <img src="@post.ImageUrl" alt="Hình ảnh bài đăng" class="post-image" />
                                                    </div>
                                                </div>
                                            }
                                            <span class="text-muted small">
                                                Đã gửi: @post.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                            </span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="share-post-form-container">
                                            <form class="share-post-form" data-product-id="@item.ProductId" data-product-name="@item.ProductName" enctype="multipart/form-data">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="orderId" value="@Model.OrderId" />
                                                <input type="hidden" name="productIds[0]" value="@item.ProductId" />
                                                <div class="mb-3">
                                                    <label class="form-label">Mô tả:</label>
                                                    <textarea name="descriptions[0]" class="form-control description-input" rows="4" placeholder="Mô tả bài viết của bạn..."></textarea>
                                                </div>
                                                <div class="mb-3 image-container">
                                                    <label class="form-label">Hình ảnh:</label>
                                                    <div class="image-upload-wrapper">
                                                        <input type="file" name="images[0]" class="form-control image-input" accept=".jpg,.jpeg,.png" />
                                                    </div>
                                                    <div class="image-preview mt-2" data-product-id="@item.ProductId"></div>
                                                </div>
                                                <button type="button" class="btn btn-yellow submit-share-post" data-product-id="@item.ProductId">Đăng bài</button>
                                            </form>
                                        </div>
                                    }
                                </div>
                            </div>
                            shareIndex++;
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-back" data-bs-dismiss="modal">Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
         turquoise <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Hàm khởi tạo trạng thái sao cho form đánh giá
            function initializeStarRatings(container) {
                $(container || '.star-rating:not(.star-rating-static)').each(function () {
                    var ratingInput = $(this).next('.rating-input');
                    var rating = parseInt(ratingInput.val()) || 0;
                    $(this).find('.star').each(function () {
                        var starValue = parseInt($(this).data('value'));
                        $(this).removeClass('bi-star bi-star-fill filled');
                        if (starValue <= rating) {
                            $(this).addClass('bi-star-fill filled');
                        } else {
                            $(this).addClass('bi-star');
                        }
                    });
                });
            }

            // Hàm đặt lại form
            function resetForm(form, type) {
                if (type === 'review') {
                    form.find('.star-rating .star').removeClass('filled').addClass('bi-star').removeClass('bi-star-fill');
                    form.find('.rating-input').val('0');
                }
                form.find('.description-input, .comment-input').val('');
                form.find('.image-input').val('');
                form.find('.image-preview').empty();
            }

            // Khởi tạo trạng thái sao khi tải trang
            initializeStarRatings();

            // Xử lý khi chọn sao
            $('.star-rating:not(.star-rating-static) .star').on('click', function () {
                var value = parseInt($(this).data('value'));
                var starRating = $(this).parent('.star-rating');
                starRating.find('.star').each(function () {
                    var starValue = parseInt($(this).data('value'));
                    $(this).removeClass('bi-star bi-star-fill filled');
                    if (starValue <= value) {
                        $(this).addClass('bi-star-fill filled');
                    } else {
                        $(this).addClass('bi-star');
                    }
                });
                starRating.next('.rating-input').val(value);
            });

            // Xử lý gửi đánh giá mới
            $('.submit-review').on('click', function () {
                var form = $(this).closest('.review-form');
                var hasValidRating = parseInt(form.find('.rating-input').val()) > 0;
                var productName = form.data('product-name');

                if (!hasValidRating) {
                    alert('Vui lòng chọn điểm đánh giá cho sản phẩm.');
                    return;
                }

                if (confirm('Bạn đang gửi đánh giá cho:\n- ' + productName + '\nBạn có chắc chắn muốn gửi?')) {
                    var formData = new FormData(form[0]);
                    $.ajax({
                        url: '@Url.Action("SubmitReview", "Review")',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                window.location.reload();
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function () {
                            alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
                        }
                    });
                }
            });

            // Xử lý cập nhật đánh giá
            $('.submit-edit-review').on('click', function () {
                var form = $(this).closest('.edit-review-form');
                var reviewId = form.data('review-id');
                var rating = parseInt(form.find('.rating-input').val());
                var productName = form.data('product-name');

                if (rating === 0) {
                    alert('Vui lòng chọn điểm đánh giá.');
                    return;
                }

                if (confirm('Bạn đang cập nhật đánh giá cho:\n- ' + productName + '\nBạn chỉ có thể cập nhật một lần. Bạn có chắc chắn muốn gửi?')) {
                    var formData = new FormData(form[0]);
                    $.ajax({
                        url: '@Url.Action("UpdateReview", "Review")',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                window.location.reload();
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function () {
                            alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
                        }
                    });
                }
            });

            // Xử lý khi mở form chỉnh sửa đánh giá
            $('[data-bs-target^="#editReview-"]').on('click', function () {
                var target = $(this).data('bs-target');
                $(target).one('shown.bs.collapse', function () {
                    initializeStarRatings(target + ' .star-rating:not(.star-rating-static)');
                });
                $('#review-details-' + $(this).data('bs-target').replace('#editReview-', '')).hide();
            });

            // Xử lý khi đóng form chỉnh sửa
            $('.collapse').on('hide.bs.collapse', function () {
                var reviewId = $(this).attr('id').replace('editReview-', '');
                $('#review-details-' + reviewId).show();
            });

            // Xử lý khi đóng modal
            $('#reviewModal, #sharePostModal').on('hidden.bs.modal', function () {
                $('.review-form, .share-post-form').each(function () {
                    resetForm($(this), $(this).hasClass('review-form') ? 'review' : 'share');
                });
                $('.edit-review-form').each(function () {
                    initializeStarRatings($(this).find('.star-rating:not(.star-rating-static)'));
                });
                $('.review-details, .post-details').show();
                $('.collapse').collapse('hide');
            });

            // Xem trước ảnh khi tải
            $('.image-input').on('change', function () {
                var preview = $(this).closest('.image-container').find('.image-preview');
                preview.empty();
                if (this.files && this.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('<img>').attr('src', e.target.result).addClass('img-fluid').css('max-height', '100px').appendTo(preview);
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Xử lý gửi bài viết chia sẻ cho từng sản phẩm
            $('.submit-share-post').on('click', function () {
                var form = $(this).closest('.share-post-form');
                var productId = $(this).data('product-id');
                var productName = form.data('product-name');
                var description = form.find('.description-input').val().trim();
                var image = form.find('.image-input')[0].files[0];

                if (!description || !image) {
                    alert('Vui lòng nhập mô tả và tải ảnh cho sản phẩm: ' + productName);
                    return;
                }

                if (confirm('Bạn đang gửi bài viết cuộc thi cho:\n- ' + productName + '\nBạn có chắc chắn muốn gửi?')) {
                    var formData = new FormData(form[0]);
                    $.ajax({
                        url: '@Url.Action("CreateContestPost", "Community")',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            alert(response.message);
                            if (response.success) {
                                $('#sharePostModal').modal('hide');
                                window.location.reload();
                            }
                        },
                        error: function (xhr) {
                            var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'Đã có lỗi xảy ra. Vui lòng thử lại.';
                            alert('Lỗi: ' + errorMessage);
                        }
                    });
                }
            });
        });

        function toggleEditReview(reviewId) {
            $('#review-details-' + reviewId).hide();
        }
    </script>
}